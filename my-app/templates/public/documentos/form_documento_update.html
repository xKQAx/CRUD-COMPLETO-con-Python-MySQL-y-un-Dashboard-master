{% extends 'public/base_cpanel.html' %}
<!--Cambiando el title-->
{% block title %}Crud con Python 游냀 | Actualizar Documento{% endblock %}

<!--Inicio del block-->
{% block body %}
<div class="card" style="border-radius: 0px !important">
  {% if respuestaDocumento|length %}
  <div class="row justify-content-center mb-2">
    <div class="col-md-12">
      <h3 class="text-center mt-5 mb-3">
        <a href="/lista-de-documentos">
          <i class="bi bi-arrow-left-circle"></i>
        </a>
        ACTUALIZAR DATOS DEL DOCUMENTO
      </h3>
      <hr />
    </div>
  </div>

  <div class="row justify-content-center mb-2">
    <div class="col-md-10">
      <form
        class="form-horizontal mx-auto"
        method="POST"
        action="{{ url_for('actualizarDocumento') }}"
        autocomplete="off"
        enctype="multipart/form-data">
        <input
          type="text"
          class="form-control"
          name="id_documento"
          value="{{ respuestaDocumento.id_documento }}"
          required
          hidden />

        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <label for="nombre_documento" class="form-label">
                Nombre del documento <span class="text-danger">*</span>
              </label>
              <input
                type="text"
                name="nombre_documento"
                value="{{ respuestaDocumento.nombre_documento }}"
                class="form-control"
                required />
            </div>
            <div class="col-md-6">
              <label for="fecha_vencimiento" class="form-label">
                Fecha de vencimiento <span class="text-danger">*</span>
              </label>
              <input
                class="form-control"
                type="date"
                name="fecha_vencimiento"
                value="{{ respuestaDocumento.fecha_vencimiento }}"
                required />
            </div>
          </div>

          <div class="row mt-2">
            <div class="col-md-12">
              <label for="archivo_documento" class="form-label">
                <strong>Archivo del documento</strong>
              </label>
              
              {% if respuestaDocumento.archivo_documento %}
                {% set archivo_ext = respuestaDocumento.archivo_documento.split('.')[-1].lower() %}
                {% set es_imagen = archivo_ext in ['jpg', 'jpeg', 'png', 'gif', 'bmp'] %}
                {% set es_pdf = archivo_ext == 'pdf' %}
                {% set nombre_archivo_corto = respuestaDocumento.archivo_documento[:30] + '...' if respuestaDocumento.archivo_documento|length > 30 else respuestaDocumento.archivo_documento %}
                
                <div class="card mb-3 border-primary">
                  <div class="card-header bg-light">
                    <h6 class="mb-0">
                      <i class="bi bi-file-earmark-check text-primary"></i> Archivo actual
                    </h6>
                  </div>
                  <div class="card-body">
                    {% if es_imagen %}
                      <!-- Vista previa de imagen -->
                      <div class="text-center mb-3">
                        <img 
                          src="/static/documentos/{{ respuestaDocumento.archivo_documento }}" 
                          alt="Vista previa" 
                          class="img-thumbnail shadow-sm" 
                          style="max-width: 400px; max-height: 300px; cursor: pointer;"
                          onclick="window.open('/static/documentos/{{ respuestaDocumento.archivo_documento }}', '_blank')"
                          title="Haz clic para ver en tama침o completo" />
                      </div>
                      <div class="text-center mb-2">
                        <span class="badge bg-info">
                          <i class="bi bi-image"></i> Imagen ({{ archivo_ext|upper }})
                        </span>
                      </div>
                    {% elif es_pdf %}
                      <!-- Vista para PDF -->
                      <div class="text-center mb-3">
                        <i class="bi bi-file-earmark-pdf" style="font-size: 5rem; color: #dc3545;"></i>
                      </div>
                      <div class="text-center mb-2">
                        <span class="badge bg-danger">
                          <i class="bi bi-file-earmark-pdf"></i> Documento PDF
                        </span>
                      </div>
                    {% else %}
                      <!-- Otros tipos de archivo -->
                      <div class="text-center mb-3">
                        <i class="bi bi-file-earmark" style="font-size: 5rem; color: #6c757d;"></i>
                      </div>
                      <div class="text-center mb-2">
                        <span class="badge bg-secondary">
                          <i class="bi bi-file-earmark"></i> Archivo ({{ archivo_ext|upper }})
                        </span>
                      </div>
                    {% endif %}
                    
                    <!-- Informaci칩n del archivo -->
                    <div class="text-center mb-3">
                      <small class="text-muted d-block mb-2">
                        <i class="bi bi-file-text"></i> 
                        <code class="text-dark">{{ nombre_archivo_corto }}</code>
                      </small>
                    </div>
                    
                    <!-- Botones de acci칩n -->
                    <div class="text-center">
                      <a 
                        href="{{ url_for('descargar_documento', nombre_archivo=respuestaDocumento.archivo_documento) }}" 
                        class="btn btn-sm btn-success me-2">
                        <i class="bi bi-download"></i> Descargar
                      </a>
                      <a 
                        href="/static/documentos/{{ respuestaDocumento.archivo_documento }}" 
                        target="_blank" 
                        class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-box-arrow-up-right"></i> Abrir en nueva pesta침a
                      </a>
                    </div>
                  </div>
                </div>
                
                <div class="alert alert-warning mb-3">
                  <i class="bi bi-info-circle"></i> 
                  <strong>Nota:</strong> Si subes un nuevo archivo, el archivo actual ser치 reemplazado.
                </div>
              {% else %}
                <div class="alert alert-info mb-3">
                  <i class="bi bi-info-circle"></i> 
                  No hay archivo asociado a este documento. Puedes subir uno ahora.
                </div>
              {% endif %}
              
              <div class="mb-3">
                <label for="archivo_documento" class="form-label">
                  <i class="bi bi-upload"></i> Subir nuevo archivo (PDF o Imagen)
                </label>
                <input
                  class="form-control"
                  type="file"
                  name="archivo_documento"
                  id="archivo_documento"
                  accept=".pdf,.jpg,.jpeg,.png,.gif,.bmp" />
                <small class="form-text text-muted">
                  <i class="bi bi-file-earmark-check"></i> 
                  Dejar vac칤o para mantener el archivo actual. Formatos permitidos: PDF, JPG, JPEG, PNG, GIF, BMP
                </small>
              </div>
            </div>
          </div>

          <div class="row mt-2">
            <div class="col-md-12">
              <label for="descripcion" class="form-label">
                Descripci칩n
              </label>
              <textarea
                class="form-control"
                name="descripcion"
                rows="3"
                placeholder="Ingrese una descripci칩n del documento (opcional)">{{ respuestaDocumento.descripcion or '' }}</textarea>
            </div>
          </div>

          <div class="row mt-4">
            <div class="col-md-12">
              <h5 class="mb-3">Configuraci칩n de Notificaciones</h5>
              <div class="card">
                <div class="card-body">
                  <!-- Campos ocultos para asegurar que siempre se env칤en valores cuando los checkboxes est치n desmarcados -->
                  <input type="hidden" name="notificar_mismo_dia" value="0" id="hidden_notificar_mismo_dia">
                  <input type="hidden" name="notificar_una_semana" value="0" id="hidden_notificar_una_semana">
                  <input type="hidden" name="notificar_un_mes" value="0" id="hidden_notificar_un_mes">
                  
                  <div class="form-check mb-2">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      name="notificar_mismo_dia"
                      value="1"
                      id="notificar_mismo_dia"
                      {% if respuestaDocumento.config_notificaciones and respuestaDocumento.config_notificaciones.get('notificar_mismo_dia', 0) == 1 %}checked{% endif %}
                      {% if not respuestaDocumento.config_notificaciones %}checked{% endif %}
                      onchange="if(this.checked) { document.getElementById('hidden_notificar_mismo_dia').disabled = true; } else { document.getElementById('hidden_notificar_mismo_dia').disabled = false; }" />
                    <label class="form-check-label" for="notificar_mismo_dia">
                      Notificar el mismo d칤a del vencimiento
                    </label>
                  </div>
                  <div class="form-check mb-2">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      name="notificar_una_semana"
                      value="1"
                      id="notificar_una_semana"
                      {% if respuestaDocumento.config_notificaciones and respuestaDocumento.config_notificaciones.get('notificar_una_semana', 0) == 1 %}checked{% endif %}
                      {% if not respuestaDocumento.config_notificaciones %}checked{% endif %}
                      onchange="if(this.checked) { document.getElementById('hidden_notificar_una_semana').disabled = true; } else { document.getElementById('hidden_notificar_una_semana').disabled = false; }" />
                    <label class="form-check-label" for="notificar_una_semana">
                      Notificar una semana antes (7 d칤as)
                    </label>
                  </div>
                  <div class="form-check mb-2">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      name="notificar_un_mes"
                      value="1"
                      id="notificar_un_mes"
                      {% if respuestaDocumento.config_notificaciones and respuestaDocumento.config_notificaciones.get('notificar_un_mes', 0) == 1 %}checked{% endif %}
                      {% if not respuestaDocumento.config_notificaciones %}checked{% endif %}
                      onchange="if(this.checked) { document.getElementById('hidden_notificar_un_mes').disabled = true; } else { document.getElementById('hidden_notificar_un_mes').disabled = false; }" />
                    <label class="form-check-label" for="notificar_un_mes">
                      Notificar un mes antes (30 d칤as)
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="mb-3 mt-4 text-center">
            <button type="submit" class="btn rounded-pill btn-primary">
              Guardar cambios
              <i class="bi bi-arrow-clockwise"></i>
            </button>
            <a href="{{ url_for('lista_documentos') }}" class="btn rounded-pill btn-secondary">
              Cancelar
            </a>
          </div>
        </div>
      </form>
    </div>
  </div>
  {% else %}
  <div class="row justify-content-center mb-2">
    <div class="col-md-12">
      <h3 class="text-center">No existe el documento</h3>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block customJS %}
<script>
// Inicializar campos ocultos al cargar la p치gina
document.addEventListener('DOMContentLoaded', function() {
    // Deshabilitar campos ocultos si los checkboxes est치n marcados
    const checkboxMismoDia = document.getElementById('notificar_mismo_dia');
    const checkboxSemana = document.getElementById('notificar_una_semana');
    const checkboxMes = document.getElementById('notificar_un_mes');
    
    const hiddenMismoDia = document.getElementById('hidden_notificar_mismo_dia');
    const hiddenSemana = document.getElementById('hidden_notificar_una_semana');
    const hiddenMes = document.getElementById('hidden_notificar_un_mes');
    
    if (checkboxMismoDia && hiddenMismoDia) {
        hiddenMismoDia.disabled = checkboxMismoDia.checked;
    }
    if (checkboxSemana && hiddenSemana) {
        hiddenSemana.disabled = checkboxSemana.checked;
    }
    if (checkboxMes && hiddenMes) {
        hiddenMes.disabled = checkboxMes.checked;
    }
});
</script>
{% endblock %}

