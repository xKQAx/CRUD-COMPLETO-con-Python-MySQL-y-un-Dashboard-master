{% extends 'public/base_cpanel.html' %}
<!--Cambiando el title-->
{% block title %}Crud con Python  | Dashboard{% endblock %}

<!--Inicio del block-->
{% block body %}

<div class="row">
  <div class="col-12 mb-4">
    <h3 class="mt-3 mb-3">Dashboard</h3>
    <hr />
  </div>
</div>

<!-- Panel de Notificaciones -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="bi bi-bell-fill text-primary"></i> Notificaciones de Documentos
        </h5>
        <button class="btn btn-sm btn-outline-primary" onclick="cargarNotificaciones()">
          <i class="bi bi-arrow-clockwise"></i> Actualizar
        </button>
      </div>
      <div class="card-body">
        <div id="panel-notificaciones">
          <div class="text-center p-3">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="text-muted mb-0 mt-2">Cargando notificaciones...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Resumen de Documentos -->
<div class="row">
  <div class="col-md-4 mb-4">
    <div class="card border-left-primary shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
              Documentos Totales
            </div>
            <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-documentos">
              <i class="bi bi-hourglass-split"></i> Cargando...
            </div>
          </div>
          <div class="col-auto">
            <i class="bi bi-file-earmark-text fa-2x text-gray-300"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-4 mb-4">
    <div class="card border-left-warning shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
              Pr贸ximos a Vencer
            </div>
            <div class="h5 mb-0 font-weight-bold text-gray-800" id="proximos-vencer">
              <i class="bi bi-hourglass-split"></i> Cargando...
            </div>
          </div>
          <div class="col-auto">
            <i class="bi bi-exclamation-triangle fa-2x text-gray-300"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-4 mb-4">
    <div class="card border-left-danger shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
              Vencidos
            </div>
            <div class="h5 mb-0 font-weight-bold text-gray-800" id="vencidos">
              <i class="bi bi-hourglass-split"></i> Cargando...
            </div>
          </div>
          <div class="col-auto">
            <i class="bi bi-x-circle fa-2x text-gray-300"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block customJS %}
<script>
// Cargar notificaciones al cargar la p谩gina
document.addEventListener('DOMContentLoaded', function() {
    cargarNotificacionesDashboard();
    cargarResumenDocumentos();
    // Recargar cada 5 minutos
    setInterval(cargarNotificacionesDashboard, 300000);
    setInterval(cargarResumenDocumentos, 300000);
});

// Funci贸n para cargar notificaciones en el dashboard
function cargarNotificacionesDashboard() {
    fetch('/api/notificaciones-pendientes')
        .then(response => response.json())
        .then(data => {
            const panel = document.getElementById('panel-notificaciones');
            
            if (data.notificaciones && data.notificaciones.length > 0) {
                let html = '<div class="list-group">';
                
                data.notificaciones.forEach(notif => {
                    let claseBadge = 'bg-primary';
                    let icono = 'bi-info-circle';
                    
                    if (notif.tipo === 'urgente' || notif.tipo === 'vencido') {
                        claseBadge = 'bg-danger';
                        icono = 'bi-exclamation-triangle-fill';
                    } else if (notif.tipo === 'advertencia') {
                        claseBadge = 'bg-warning';
                        icono = 'bi-exclamation-circle-fill';
                    }
                    
                    const fechaVencimiento = new Date(notif.fecha_vencimiento).toLocaleDateString('es-ES', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                    
                    html += `
                        <a href="/detalles-documento/${notif.id_documento}" class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">
                                    <i class="bi ${icono} text-${notif.tipo === 'urgente' || notif.tipo === 'vencido' ? 'danger' : notif.tipo === 'advertencia' ? 'warning' : 'info'}"></i>
                                    ${notif.mensaje}
                                </h6>
                                <span class="badge ${claseBadge} rounded-pill">${notif.dias_restantes} d铆as</span>
                            </div>
                            <p class="mb-1">Fecha de vencimiento: ${fechaVencimiento}</p>
                        </a>
                    `;
                });
                
                html += '</div>';
                panel.innerHTML = html;
            } else {
                panel.innerHTML = `
                    <div class="text-center p-4">
                        <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-3 mb-0">No hay notificaciones pendientes</p>
                        <small class="text-muted">Todos los documentos est谩n al d铆a</small>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error al cargar notificaciones:', error);
            document.getElementById('panel-notificaciones').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> Error al cargar notificaciones
                </div>
            `;
        });
}

// Funci贸n para cargar resumen de documentos
function cargarResumenDocumentos() {
    fetch('/api/documentos-proximos-vencer?dias=30')
        .then(response => response.json())
        .then(documentos => {
            // Contar documentos
            const total = documentos.length;
            const proximos = documentos.filter(d => d.dias_restantes > 0 && d.dias_restantes <= 30).length;
            const vencidos = documentos.filter(d => d.dias_restantes < 0).length;
            
            document.getElementById('total-documentos').textContent = total;
            document.getElementById('proximos-vencer').textContent = proximos;
            document.getElementById('vencidos').textContent = vencidos;
        })
        .catch(error => {
            console.error('Error al cargar resumen:', error);
        });
}

// Funci贸n para recargar notificaciones (usada por el bot贸n)
function cargarNotificaciones() {
    cargarNotificacionesDashboard();
}
</script>
{% endblock %}

